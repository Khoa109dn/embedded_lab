#include "servo.h"

void Servo_Init(void)
{
    RCC->APB2ENR |= RCC_APB2ENR_IOPAEN | RCC_APB2ENR_TIM1EN;

    // PA8 = TIM1_CH1, AF Push-Pull 50MHz
    GPIOA->CRH &= ~(0xF << 0);
    GPIOA->CRH |=  (0xB << 0);

    TIM1->PSC = 71;        // 72MHz / (71+1) = 1MHz
    TIM1->ARR = 20000;    // 20ms (50Hz)

    // PWM mode 1 on CH1
    TIM1->CCMR1 &= ~(0xFF);
    TIM1->CCMR1 |= (6 << 4);      // OC1M = 110 (PWM1)
    TIM1->CCMR1 |= (1 << 3);      // OC1PE enable

    TIM1->CCR1 = 1500;            // TRUNG TÂM SERVO (1.5ms)

    TIM1->CCER |= TIM_CCER_CC1E;  // enable CH1
    TIM1->BDTR |= TIM_BDTR_MOE;   // MAIN OUTPUT ENABLE (RẤT QUAN TRỌNG)

    TIM1->CR1 |= TIM_CR1_ARPE;
    TIM1->CR1 |= TIM_CR1_CEN;
}

void Servo_SetAngle(uint8_t angle)
{
    if (angle > 180) angle = 180;
    TIM1->CCR1 = 500 + (angle * 2000) / 180;
}
