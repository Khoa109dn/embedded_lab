#include "ssd1306.h"
#include "spi.h"
#include "fonts.h"

#define CS_LOW()   GPIOA->BRR  = (1<<4)
#define CS_HIGH()  GPIOA->BSRR = (1<<4)
#define DC_CMD()   GPIOB->BRR  = (1<<1)
#define DC_DATA()  GPIOB->BSRR = (1<<1)
#define RES_LOW()  GPIOB->BRR  = (1<<0)
#define RES_HIGH() GPIOB->BSRR = (1<<0)

static void delay(volatile uint32_t t)
{
    while (t--);
}

static void OLED_Cmd(uint8_t cmd)
{
    DC_CMD();
    CS_LOW();
    SPI1_Write(cmd);
    CS_HIGH();
}

void SSD1306_Init(void)
{
    RCC->APB2ENR |= RCC_APB2ENR_IOPAEN | RCC_APB2ENR_IOPBEN;

    // PA4 CS
    GPIOA->CRL &= ~(0xF << 16);
    GPIOA->CRL |=  (0x3 << 16);

    // PB0 RES, PB1 DC
    GPIOB->CRL &= ~((0xF << 0) | (0xF << 4));
    GPIOB->CRL |=  ((0x3 << 0) | (0x3 << 4));

    RES_LOW();
    for (volatile int i = 0; i < 50000; i++);
    RES_HIGH();

    OLED_Cmd(0xAE); // display OFF
    OLED_Cmd(0x20); // memory addressing
    OLED_Cmd(0x00); // horizontal
    OLED_Cmd(0xB0); // page 0
    OLED_Cmd(0xC8); // COM scan direction
    OLED_Cmd(0x00); // low column
    OLED_Cmd(0x10); // high column
    OLED_Cmd(0x40); // start line
    OLED_Cmd(0x81); // contrast
    OLED_Cmd(0x7F);
    OLED_Cmd(0xA1); // segment remap
    OLED_Cmd(0xA6); // normal display
    OLED_Cmd(0xA8); // multiplex
    OLED_Cmd(0x3F);
    OLED_Cmd(0xA4); // output RAM
    OLED_Cmd(0xD3); // offset
    OLED_Cmd(0x00);
    OLED_Cmd(0xD5); // clock
    OLED_Cmd(0x80);
    OLED_Cmd(0xD9); // precharge
    OLED_Cmd(0xF1);
    OLED_Cmd(0xDA); // com pins
    OLED_Cmd(0x12);
    OLED_Cmd(0xDB); // vcom detect
    OLED_Cmd(0x40);
    OLED_Cmd(0x8D); // charge pump
    OLED_Cmd(0x14);
    OLED_Cmd(0xAF); // display ON
}
