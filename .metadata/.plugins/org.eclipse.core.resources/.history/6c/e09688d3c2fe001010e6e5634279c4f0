#include "can.h"

void CAN_Init(void)
{
    RCC->APB1ENR |= RCC_APB1ENR_CAN1EN;
    RCC->APB2ENR |= RCC_APB2ENR_IOPAEN;

    /* PA11 RX input floating */
    GPIOA->CRH &= ~(0xF << 12);
    GPIOA->CRH |=  (0x4 << 12);

    /* PA12 TX AF push-pull */
    GPIOA->CRH &= ~(0xF << 16);
    GPIOA->CRH |=  (0xB << 16);

    CAN1->MCR |= CAN_MCR_INRQ;
    while (!(CAN1->MSR & CAN_MSR_INAK));

    /* 500 kbps @ 36MHz APB1 (example) */
    CAN1->BTR =
        (3 << 20) |   // SJW
        (12 << 16) |  // TS2
        (5 << 0);     // Prescaler

    /* Accept all filter */
    CAN1->FMR |= CAN_FMR_FINIT;
    CAN1->FA1R |= 1;
    CAN1->FMR &= ~CAN_FMR_FINIT;

    CAN1->MCR &= ~CAN_MCR_INRQ;
}

uint8_t CAN_ReceiveAngle(uint8_t *angle)
{
    if (CAN1->RF0R & CAN_RF0R_FMP0)
    {
        *angle = CAN1->sFIFOMailBox[0].RDLR & 0xFF;
        CAN1->RF0R |= CAN_RF0R_RFOM0;
        return 1;
    }
    return 0;
}
