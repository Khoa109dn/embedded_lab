#include "stm32f103xb.h"
#include "spi.h"
#include "servo.h"
#include "ssd1306.h"

void SystemClock_Config(void)
{
    RCC->CR |= RCC_CR_HSEON;
    while (!(RCC->CR & RCC_CR_HSERDY));

    FLASH->ACR |= FLASH_ACR_PRFTBE;
    FLASH->ACR &= ~FLASH_ACR_LATENCY;
    FLASH->ACR |= FLASH_ACR_LATENCY_2;

    RCC->CFGR |= RCC_CFGR_PLLSRC;
    RCC->CFGR |= RCC_CFGR_PLLMULL9;   // 8MHz * 9 = 72MHz

    RCC->CR |= RCC_CR_PLLON;
    while (!(RCC->CR & RCC_CR_PLLRDY));

    RCC->CFGR |= RCC_CFGR_SW_PLL;
    while ((RCC->CFGR & RCC_CFGR_SWS) != RCC_CFGR_SWS_PLL);
}

int main(void)
{
    SystemClock_Config();   // ⭐ BẮT BUỘC

    SPI1_Init();
    SSD1306_Init();
    SSD1306_Clear();

    Servo_Init();

    uint8_t angle = 0;

    while (1)
    {
        Servo_SetAngle(angle);
        SSD1306_Clear();
        SSD1306_Print("HELLO");

        angle += 10;
        if (angle > 180) angle = 0;

        for (volatile int i = 0; i < 3000000; i++);
    }
}
