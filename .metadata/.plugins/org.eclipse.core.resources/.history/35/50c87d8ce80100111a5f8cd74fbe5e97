#include "ssd1306.h"
#include "stm32f103xb.h"
#include "spi.h"
#include "fonts.h"

/* ===== PIN MACRO ===== */
#define CS_LOW()    (GPIOA->BRR  = (1<<4))
#define CS_HIGH()   (GPIOA->BSRR = (1<<4))

#define DC_CMD()    (GPIOB->BRR  = (1<<1))
#define DC_DATA()   (GPIOB->BSRR = (1<<1))

#define RES_LOW()   (GPIOB->BRR  = (1<<0))
#define RES_HIGH()  (GPIOB->BSRR = (1<<0))

/* ===== DELAY ===== */
static void delay(volatile uint32_t t)
{
    while (t--);
}

/* ===== SEND COMMAND ===== */
static void OLED_SendCmd(uint8_t cmd)
{
    DC_CMD();
    CS_LOW();
    SPI1_Write(cmd);
    CS_HIGH();
}

/* ===== SEND DATA ===== */
static void OLED_SendData(uint8_t data)
{
    DC_DATA();
    CS_LOW();
    SPI1_Write(data);
    CS_HIGH();
}

/* ===== INIT OLED ===== */
void SSD1306_Init(void)
{
    /* Enable GPIO clock */
    RCC->APB2ENR |= RCC_APB2ENR_IOPAEN | RCC_APB2ENR_IOPBEN;

    /* PA4 (CS) output push-pull */
    GPIOA->CRL &= ~(0xF << 16);
    GPIOA->CRL |=  (0x3 << 16);

    /* PB0 (RES), PB1 (DC) output push-pull */
    GPIOB->CRL &= ~((0xF << 0) | (0xF << 4));
    GPIOB->CRL |=  ((0x3 << 0) | (0x3 << 4));

    /* Reset OLED */
    RES_LOW();
    delay(30000);
    RES_HIGH();
    delay(30000);

    /* Init sequence (SSD1306 SPI) */
    OLED_SendCmd(0xAE); // Display OFF
    OLED_SendCmd(0x20); // Set memory mode
    OLED_SendCmd(0x00); // Horizontal addressing
    OLED_SendCmd(0xB0); // Page 0
    OLED_SendCmd(0xC8); // COM scan direction
    OLED_SendCmd(0x00); // Low column
    OLED_SendCmd(0x10); // High column
    OLED_SendCmd(0x40); // Start line
    OLED_SendCmd(0x81); // Contrast
    OLED_SendCmd(0xFF);
    OLED_SendCmd(0xA1); // Segment remap
    OLED_SendCmd(0xA6); // Normal display
    OLED_SendCmd(0xA8); // Multiplex
    OLED_SendCmd(0x3F);
    OLED_SendCmd(0xA4);
    OLED_SendCmd(0xD3);
    OLED_SendCmd(0x00);
    OLED_SendCmd(0xD5);
    OLED_SendCmd(0xF0);
    OLED_SendCmd(0xD9);
    OLED_SendCmd(0x22);
    OLED_SendCmd(0xDA);
    OLED_SendCmd(0x12);
    OLED_SendCmd(0xDB);
    OLED_SendCmd(0x20);
    OLED_SendCmd(0x8D);
    OLED_SendCmd(0x14);
    OLED_SendCmd(0xAF); // Display ON

    SSD1306_Clear();
}

/* ===== CLEAR SCREEN ===== */
void SSD1306_Clear(void)
{
    for (uint8_t page = 0; page < 8; page++)
    {
        OLED_SendCmd(0xB0 + page);
        OLED_SendCmd(0x00);
        OLED_SendCmd(0x10);

        for (uint8_t col = 0; col < 128; col++)
        {
            OLED_SendData(0x00);
        }
    }
}

/* ===== PRINT STRING ===== */
void SSD1306_Print(char *str)
{
    OLED_SendCmd(0xB0); // Page 0
    OLED_SendCmd(0x00);
    OLED_SendCmd(0x10);

    while (*str)
    {
        if (*str < 32 || *str > 127)
        {
            str++;
            continue;
        }

        for (uint8_t i = 0; i < 5; i++)
        {
            OLED_SendData(Font5x7[*str - 32][i]);
        }
        OLED_SendData(0x00);
        str++;
    }
}
