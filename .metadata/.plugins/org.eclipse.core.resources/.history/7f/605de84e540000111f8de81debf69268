#include "spi.h"

void SPI1_Init(void) {
    RCC->APB2ENR |= RCC_APB2ENR_SPI1EN | RCC_APB2ENR_IOPBEN;

    // PB3 = SCK, PB5 = MOSI
    GPIOB->CRL &= ~(GPIO_CRL_MODE3 | GPIO_CRL_CNF3 |
                    GPIO_CRL_MODE5 | GPIO_CRL_CNF5);

    GPIOB->CRL |= (GPIO_CRL_MODE3_1 | GPIO_CRL_CNF3_1);
    GPIOB->CRL |= (GPIO_CRL_MODE5_1 | GPIO_CRL_CNF5_1);

    SPI1->CR1 =
        SPI_CR1_MSTR |
        SPI_CR1_SSM  |
        SPI_CR1_SSI  |
        SPI_CR1_BR_1;

    SPI1->CR1 |= SPI_CR1_SPE;
}

void SPI1_WriteByte(uint8_t data) {
    while (!(SPI1->SR & SPI_SR_TXE));
    SPI1->DR = data;
    while (SPI1->SR & SPI_SR_BSY);
}
